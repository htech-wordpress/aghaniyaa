rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions ---
    function isSuperUser() {
      return request.auth != null && 
             exists(/databases/$(database)/documents/adminConfig/superusers) &&
             get(/databases/$(database)/documents/adminConfig/superusers).data.emails != null &&
             request.auth.token.email in get(/databases/$(database)/documents/adminConfig/superusers).data.emails;
    }

    function isAdmin() {
      return request.auth != null && (
        // Explicit admin by UID
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        // Or is superuser
        || isSuperUser()
        // Or listed in permitted admin emails
        || (exists(/databases/$(database)/documents/adminConfig/access) && 
            get(/databases/$(database)/documents/adminConfig/access).data.adminEmails != null &&
            request.auth.token.email in get(/databases/$(database)/documents/adminConfig/access).data.adminEmails)
      );
    }

    // --- Admin config & protected collections ---

    match /adminConfig/superusers {
      allow read: if request.auth != null;
      allow write: if request.auth != null && (
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) ||
        isSuperUser() ||
        (request.resource.data.emails != null && request.auth.token.email in request.resource.data.emails)
      );
    }

    match /adminConfig/access {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
    }

    match /admins/{adminId} {
      allow read: if request.auth != null && (request.auth.uid == adminId || isAdmin());
      allow write: if request.auth != null && (
        request.auth.uid == adminId ||
        isSuperUser()
      );
    }

    match /settings/{document} {
      allow read, write: if request.auth != null;
    }

    match /agents/{agentId} {
      allow read, write: if request.auth != null;
    }

    match /adminUsers/{adminUserId} {
      allow read: if request.auth != null;
      allow write: if isSuperUser();
    }

    // --- Leads collection (public form submissions) ---
    // We allow unauthenticated clients to create leads, but we validate the payload
    match /leads/{leadId} {
      allow read: if request.auth != null;

      allow create: if (
        // top-level shape
        request.resource.data is map &&
        // category is required and should be a string
        (request.resource.data.category is string) &&
        // timestamp should be a timestamp or string (many clients submit ISO strings)
        ((request.resource.data.timestamp is timestamp) || (request.resource.data.timestamp is string)) &&
        // data object must exist and contain required fields
        (request.resource.data.data is map) &&
        (request.resource.data.data.fullName is string && request.resource.data.data.fullName.size() > 1) &&
        (request.resource.data.data.mobile is string && request.resource.data.data.mobile.size() >= 7) &&
        (
          // email is optional but if present must be a valid-looking email
          !(request.resource.data.data.keys().hasAny(['email'])) ||
          (request.resource.data.data.email is string && request.resource.data.data.email.matches('^.+@.+\\..+$'))
        ) &&
        (request.resource.data.data.source is string) &&
        (request.resource.data.data.status is string)
      );

      // Allow updates only by admins or the assigned agent (if authenticated)
      allow update: if isAdmin() || (
        request.auth != null &&
        resource.data.data.assignedTo != null &&
        exists(/databases/$(database)/documents/agents/$(resource.data.data.assignedTo)) &&
        get(/databases/$(database)/documents/agents/$(resource.data.data.assignedTo)).data.email == request.auth.token.email
      );

      allow delete: if isAdmin();
    }

    // Allow additional collections to be defined below as needed
  }
}